# מדריך הגדרה: שדרוג WhatsApp API ואוטומציה ל-GitHub

מדריך זה מפרט את השלבים הנדרשים להפעלת שתי המערכות שפותחו: אינטגרציית WhatsApp Business Cloud API המוגנת מפני חסימה, ומערכת האוטומציה לסינכרון מטא-דאטה ב-GitHub.

## 1. הגדרת אינטגרציית WhatsApp API

האינטגרציה נבנתה באמצעות Python ו-FastAPI, ללא שימוש ב-SDK חיצוני, בהתאם להנחיות "Aviel.AI Safety Guidelines".

### א. משתני סביבה נדרשים

יש להגדיר את משתני הסביבה הבאים בסביבת ההרצה שלכם (למשל, בקובץ `.env` או בהגדרות השרת):

| משתנה סביבה | תיאור | מקור |
| :--- | :--- | :--- |
| `WHATSAPP_TOKEN` | **Permanent System User Token** (אסימון משתמש מערכת קבוע) עם ההרשאות המתאימות (כגון `whatsapp_business_messaging`, `whatsapp_business_management`). זהו האסימון שבו המערכת תשתמש לשליחת הודעות. | Meta Business Manager |
| `WHATSAPP_PHONE_NUMBER_ID` | מזהה מספר הטלפון העסקי שלכם ב-WhatsApp. | Meta Business Manager |
| `WHATSAPP_VERIFY_TOKEN` | אסימון אימות סודי שתגדירו ב-Meta Business Manager לצורך אימות Webhooks. | מוגדר על ידכם |

### ב. שכבת בטיחות (Safety Layer)

המערכת כוללת שתי שכבות בטיחות מובנות:

1.  **מנהל ביטול הרשמה (Opt-Out Manager):**
    *   המערכת מאזינה להודעות נכנסות דרך ה-Webhook.
    *   משתמשים המגיבים עם המילים **"הסר"** או **"Stop"** (או מילים דומות כגון "unsubscribe", "remove") יתווספו אוטומטית לקובץ `opt_out_list.json` ולא יישלחו אליהם הודעות נוספות.
2.  **לוגיקת "חימום" (Warm-up Logic):**
    *   המערכת מגבילה את כמות ההודעות היומית הנשלחת כדי למנוע סימון (Flagging) של החשבון.
    *   **שבוע 1:** עד 20 הודעות ביום.
    *   **שבוע 2:** עד 50 הודעות ביום.
    *   **שבוע 3 ואילך:** עד 100 הודעות ביום (ניתן להגדיל בהדרגה).
    *   הסטטיסטיקות נשמרות בקובץ `warmup_stats.json`.

### ג. הפעלת Webhooks (FastAPI)

הקובץ `src/api/webhook.py` מכיל את נקודת הקצה (Endpoint) של FastAPI לטיפול באימות ובקבלת עדכוני סטטוס והודעות נכנסות.

*   **אימות:** נקודת הקצה `/webhook` מטפלת באימות הנדרש על ידי Meta.
*   **טיפול בהודעות:** כל הודעה נכנסת עוברת בדיקה על ידי מנהל ביטול ההרשמה.

**הערה:** כדי ש-Meta תוכל לשלוח עדכונים, יש צורך שהשרת המריץ את ה-Webhook יהיה נגיש ציבורית (Publicly Accessible).

## 2. אוטומציה לסינכרון מטא-דאטה ב-GitHub

מערכת זו מיושמת באמצעות GitHub Action שרצה מדי יום ומבצעת שתי פעולות מרכזיות בכל המאגרים הציבוריים תחת חשבון `Avielzi`.

### א. הגדרת GITHUB_TOKEN

כדי שהאוטומציה תוכל לקרוא סטטיסטיקות ולעדכן קבצים ותגיות, יש ליצור אסימון גישה אישי (Personal Access Token - PAT) או להשתמש ב-`GITHUB_TOKEN` המובנה של ה-Action עם הרשאות מתאימות.

**מומלץ:** ליצור PAT עם ההרשאות (Scopes) הבאות:
*   `repo` (מלא) - לצורך עדכון קבצי `README.md` ותגיות (Topics).

יש לשמור את האסימון כסוד (Secret) בשם **`SYNC_TOKEN`** בהגדרות ה-GitHub של המשתמש/ארגון.

### ב. סינכרון סטטיסטיקות ועדכון README

הסקריפט (`scripts/sync_meta.py`) יבצע את הפעולות הבאות:
1.  **איסוף נתונים:** יאסוף את מספר הכוכבים (`Stars`), הפיצולים (`Forks`), העוקבים (`Watchers`) ומספר הצפיות (`Views`) של המאגר.
2.  **עדכון README:** יחפש את התגית `<!-- REPO_STATS_START -->` בקובץ `README.md` ויעדכן את טבלת הסטטיסטיקות המופיעה אחריה. אם התגית אינה קיימת, הוא יוסיף את הטבלה בסוף הקובץ.

### ג. תיוג אוטומטי (Auto-Tagging) באנגלית

בהתאם לבקשתך, הסקריפט יסרוק את שם המאגר ויעדכן את התגיות (Topics) שלו ב-GitHub.

*   **תגיות בסיס (אנגלית):** המערכת מוסיפה אוטומטית תגיות רלוונטיות לאופטימיזציה בחיפוש גלובלי, כגון: `ai`, `artificial-intelligence`, `automation`, `python`, `api-safety`.
*   **תגיות ספציפיות:** אם שם המאגר מכיל "whatsapp", יתווספו גם `whatsapp-api` ו-`meta-api`.

### ד. הפעלת ה-GitHub Action

קובץ ה-Workflow (`.github/workflows/sync-all.yml`) מוגדר לרוץ:
1.  **מדי יום בחצות (UTC):** באמצעות `cron: '0 0 * * *'`.
2.  **ידנית:** באמצעות `workflow_dispatch` (כפתור "Run workflow" ב-GitHub).

**הערה:** יש למקם את הקובץ `sync_meta.py` בנתיב `.github/scripts/` ואת קובץ ה-Workflow בנתיב `.github/workflows/` בכל מאגר שבו תרצו להפעיל את האוטומציה.
